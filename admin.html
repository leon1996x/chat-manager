<!DOCTYPE html>
<html>
<head>
    <title>–ê–¥–º–∏–Ω–∫–∞ —á–∞—Ç–∞</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .login-container { max-width: 400px; margin: 100px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .admin-container { display: none; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .online { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .offline { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        .clients-list { margin: 20px 0; }
        .client { padding: 10px; border: 1px solid #ddd; margin: 5px 0; cursor: pointer; border-radius: 5px; }
        .client:hover { background: #f8f9fa; }
        .client.active { background: #007bff; color: white; }
        .chat-area { border: 1px solid #ddd; padding: 10px; height: 400px; overflow-y: auto; margin: 10px 0; border-radius: 5px; }
        .message { margin: 5px 0; padding: 8px; border-radius: 5px; max-width: 80%; }
        .client-message { background: #f1f1f1; align-self: flex-start; }
        .manager-message { background: #007bff; color: white; align-self: flex-end; margin-left: auto; }
        .messages-container { display: flex; flex-direction: column; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-online { background: #28a745; color: white; }
        .btn-offline { background: #dc3545; color: white; }
        input[type="text"], input[type="password"] { 
            padding: 10px; 
            width: 100%; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            margin: 5px 0; 
            box-sizing: border-box;
        }
        .form-group { margin: 15px 0; }
        .logout-btn { background: #6c757d; color: white; float: right; }
        .error { color: #dc3545; margin: 10px 0; }
        .success { color: #28a745; margin: 10px 0; }
    </style>
</head>
<body>
    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
    <div id="login-container" class="login-container">
        <h2>üîê –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É</h2>
        <form id="login-form">
            <div class="form-group">
                <label>–õ–æ–≥–∏–Ω:</label>
                <input type="text" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" required>
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
            </div>
            <button type="submit" style="background: #007bff; color: white; width: 100%;">–í–æ–π—Ç–∏</button>
        </form>
        <div id="login-message"></div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="admin-container" class="admin-container">
        <button class="logout-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
        <h1>üìû –ê–¥–º–∏–Ω–∫–∞ —á–∞—Ç–∞</h1>
        
        <div id="status" class="status offline">
            üî¥ –°—Ç–∞—Ç—É—Å: –ù–µ –≤ —Å–µ—Ç–∏
        </div>
        
        <button class="btn-online" onclick="setStatus(true)">üü¢ –Ø –≤ —Å–µ—Ç–∏</button>
        <button class="btn-offline" onclick="setStatus(false)">üî¥ –Ø –Ω–µ –≤ —Å–µ—Ç–∏</button>
        
        <div class="clients-list">
            <h3>üë• –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã:</h3>
            <div id="clients-container">
                <div style="padding: 10px; color: #6c757d;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
            </div>
        </div>
        
        <div id="chat-container" style="display: none;">
            <h3>üí¨ –ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º: <span id="current-client"></span></h3>
            <div id="chat-area" class="chat-area">
                <div class="messages-container" id="messages-container"></div>
            </div>
            <div>
                <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="checkEnter(event)">
                <button onclick="sendMessage()" style="background: #28a745; color: white;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let currentClientId = null;
        let authToken = null;
        let statusInterval, messagesInterval;

        // –õ–æ–≥–∏–Ω
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageEl = document.getElementById('login-message');
            
            try {
                const response = await fetch(`${API_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    authToken = data.token;
                    messageEl.className = 'success';
                    messageEl.textContent = '‚úÖ ' + data.message;
                    
                    document.getElementById('login-container').style.display = 'none';
                    document.getElementById('admin-container').style.display = 'block';
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
                    startDataPolling();
                } else {
                    messageEl.className = 'error';
                    messageEl.textContent = '‚ùå ' + data.message;
                }
            } catch (error) {
                messageEl.className = 'error';
                messageEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
            }
        });

        // –í—ã—Ö–æ–¥
        async function logout() {
            try {
                await fetch(`${API_URL}/api/logout`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': authToken 
                    }
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
            }
            
            authToken = null;
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('admin-container').style.display = 'none';
            document.getElementById('password').value = '';
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ä–æ—Å—ã
            clearInterval(statusInterval);
            clearInterval(messagesInterval);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': authToken
            };
        }

        async function setStatus(online) {
            try {
                const response = await fetch(`${API_URL}/api/status`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ online: online })
                });
                
                updateStatus(online);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
                alert('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞');
            }
        }

        function updateStatus(online) {
            const statusEl = document.getElementById('status');
            if (online) {
                statusEl.textContent = 'üü¢ –°—Ç–∞—Ç—É—Å: –í —Å–µ—Ç–∏';
                statusEl.className = 'status online';
            } else {
                statusEl.textContent = 'üî¥ –°—Ç–∞—Ç—É—Å: –ù–µ –≤ —Å–µ—Ç–∏';
                statusEl.className = 'status offline';
            }
        }

        async function loadClients() {
            if (!authToken) return;
            
            try {
                const response = await fetch(`${API_URL}/api/clients`, {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const clients = await response.json();
                const container = document.getElementById('clients-container');
                
                if (clients.length === 0) {
                    container.innerHTML = '<div style="padding: 10px; color: #6c757d;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>';
                    return;
                }
                
                container.innerHTML = '';
                
                clients.forEach(client => {
                    const clientEl = document.createElement('div');
                    clientEl.className = 'client';
                    if (client.clientId === currentClientId) {
                        clientEl.classList.add('active');
                    }
                    clientEl.innerHTML = `
                        <strong>üë§ –ö–ª–∏–µ–Ω—Ç:</strong> ${client.clientId}<br>
                        <small>üìù –°–æ–æ–±—â–µ–Ω–∏–π: ${client.messageCount}</small><br>
                        <small>‚è∞ –ê–∫—Ç–∏–≤–µ–Ω: ${new Date(client.lastActivity).toLocaleString()}</small>
                    `;
                    clientEl.onclick = () => selectClient(client.clientId);
                    container.appendChild(clientEl);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤:', error);
            }
        }

        function selectClient(clientId) {
            currentClientId = clientId;
            document.getElementById('current-client').textContent = clientId;
            document.getElementById('chat-container').style.display = 'block';
            loadMessages();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ
            document.querySelectorAll('.client').forEach(el => {
                el.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        async function loadMessages() {
            if (!currentClientId || !authToken) return;
            
            try {
                const response = await fetch(`${API_URL}/api/messages/${currentClientId}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const messages = await response.json();
                const container = document.getElementById('messages-container');
                container.innerHTML = '';
                
                messages.forEach(msg => {
                    const messageEl = document.createElement('div');
                    messageEl.className = `message ${msg.sender === 'client' ? 'client-message' : 'manager-message'}`;
                    messageEl.textContent = msg.message;
                    container.appendChild(messageEl);
                });
                
                container.scrollTop = container.scrollHeight;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            }
        }

        async function sendMessage() {
            if (!currentClientId || !authToken) return;
            
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                const response = await fetch(`${API_URL}/api/manager-message`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        clientId: currentClientId,
                        message: message
                    })
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                input.value = '';
                loadMessages();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
        }

        function checkEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function startDataPolling() {
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
            statusInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_URL}/api/status`);
                    const data = await response.json();
                    updateStatus(data.online);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
                }
            }, 5000);

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
            messagesInterval = setInterval(() => {
                if (currentClientId) {
                    loadMessages();
                }
                loadClients();
            }, 3000);

            // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
            loadClients();
            fetch(`${API_URL}/api/status`)
                .then(response => response.json())
                .then(data => updateStatus(data.online))
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
                });
        }
    </script>
</body>
</html>
